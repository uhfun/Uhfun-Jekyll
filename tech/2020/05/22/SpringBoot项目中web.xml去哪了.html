<!DOCTYPE html>
<html lang="zh-CN"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="傅杭波, Uhfun傅杭波, Uhfun, UhfunBlog, Hbson傅杭波, Hb, Hbson, 博客, 个人网站, 互联网, 后端, Web, Java, Spring, 翻唱, 唱歌">
  <meta name="description" content='代码与生活、热爱唱歌的boy | 傅杭波的个人博客'>
  <meta name="robots" content="all">
  <meta property="og:type" content="post" /><meta property="og:title" content="SpringBoot项目中web.xml去哪了 | UhfunBlog" />
  <meta property="og:image" content='https://uhfun.cn/assetshttps://s1.ax1x.com/2020/06/04/t0QjeK.jpg' />
  <meta property="og:type" content="article">
  <meta property="og:description" content="记得在Spring+SpringMVC的日子里，创建一个spring的web项目，必不可少的配置就是在WEB-INF目录下添加web.xml。为什么在SpringBoot项目中，web.xml消失的无影无踪呢？

"><meta property="article:published_time" content='2020-05-22T15:10:00Z'><meta property="article:author" content="傅杭波"><meta property="og:image" content="" >
  <meta property="og:url" content="https://uhfun.cn/tech/2020/05/22/SpringBoot%E9%A1%B9%E7%9B%AE%E4%B8%ADweb.xml%E5%8E%BB%E5%93%AA%E4%BA%86.html"><meta property="article:tag" content="SpringBoot"><meta property="article:tag" content="SpringMVC"><meta property="og:site_name" content="傅杭波的博客UhfunBlog" />
  <meta name="baidu-site-verification" content= "9DYfdd4yEo" />
  <meta name="google-site-verification" content="uDSkqT9lEtkk2RsKYeldTKkmr4u_yI5aR3Y-tGgjcBo" />
  <title>SpringBoot项目中web.xml去哪了 | UhfunBlog</title>
  <!-- Favicon -->
  <link rel="shortcut icon" href="/uhfun-jekyll/assets/img/favicon.ico">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/uhfun-jekyll/assets/css/main.css"><link type="application/atom+xml" rel="alternate" href="https://uhfun.cn/uhfun-jekyll/feed.xml" title="UhfunBlog" /><script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/font-awesome/5.11.2/js/all.min.js"></script>
</head><body><header class="navbar has-shadow is-spaced" role="banner">
  <div class="container"><div class="navbar-brand">
      <a class="navbar-item" href="/uhfun-jekyll/">
        <img src='https://s1.ax1x.com/2020/06/04/t0QDIg.png' width="160">
      </a>
      <div role="button" class="navbar-burger burger" data-target="navbarExampleTransparentExample">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </div>
    </div>
    <div class="navbar-menu">      
      <div class="navbar-end">
        <a class='navbar-item' href='/uhfun-jekyll/'>主页</a><a class="navbar-item" href="/uhfun-jekyll/README.html">自述
        </a><a class="navbar-item" href="/uhfun-jekyll/tag/">标签
        </a><a class="navbar-item" href="/uhfun-jekyll/search/">搜索
        </a><a class="navbar-item" href="/uhfun-jekyll/life/">生活
        </a><a class="navbar-item" href="/uhfun-jekyll/tech/">技术
        </a><div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
              <img class="is-rounded" src='https://s1.ax1x.com/2020/06/04/t0QjeK.jpg'>
          </a>
          <div class="navbar-dropdown is-right">
            <a class="icon-dropdown navbar-item" href="/uhfun-jekyll/about.html">
              <i class="far fa-user" aria-hidden="true"></i> 关于
            </a>
            <a class="icon-dropdown navbar-item" href="https://github.com/uhfun">
              <i class="fab fa-github" aria-hidden="true"></i> Github
            </a>
            <hr class="navbar-divider">
            <a class="navbar-item" href="/uhfun-jekyll/README.html#utterances"> 报告问题
            </a>
          </div>
        </div>
      </div>
    </div></div>
</header>
<div class="section">
    <div class="container">
      <article class="page">
  <div class="content">
    <article class="post"><h1 class="title is-spaced">SpringBoot项目中web.xml去哪了</h1><div class="tags">
    <div class="container"><span class="icon is-small">
            <i class="fa fa-tags" aria-hidden="true"></i>
        </span><a href="/uhfun-jekyll/tag/springboot">SpringBoot</a><a href="/uhfun-jekyll/tag/springmvc">SpringMVC</a>
        <span class="spot">•</span>
        <span class='formated-date' data-time="2020/05/22 15:10:00">
            2020-05-22
        </span><span class="spot">•</span>
        <span>14分钟
        </span></div>
</div><div class='post-img'></div><div class="article_license">
      <p>
        <strong>版权声明：本文为博主原创文章，遵循</strong> 
        <a target="_blank" href="http://creativecommons.org/licenses/by-sa/4.0/">CC 4.0 BY-SA</a>       
        <strong>版权协议，转载请附上原文出处链接和本声明。</strong>    
        <br>    
        <strong>本文链接：</strong> 
        <a target="_blank" href="https://uhfun.cn/tech/2020/05/22/SpringBoot项目中web.xml去哪了.html">https://uhfun.cn/tech/2020/05/22/SpringBoot项目中web.xml去哪了.html</a>        
      </p>
    </div><div class='post-content'>
    <div id="toc"></div><p>记得在Spring+SpringMVC的日子里，创建一个spring的web项目，必不可少的配置就是在<code class="language-plaintext highlighter-rouge">WEB-INF</code>目录下添加<code class="language-plaintext highlighter-rouge">web.xml</code>。为什么在SpringBoot项目中，<code class="language-plaintext highlighter-rouge">web.xml</code>消失的无影无踪呢？</p>

<p>我的观点是：如果使用外部的tomcat，SpringBoot会通过<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>在<code class="language-plaintext highlighter-rouge">ApplicationContext</code>应用上下文创建之前就生成ServletContext，但是servlet配置的注册是由<code class="language-plaintext highlighter-rouge">DispatcherServletRegistrationBean</code>来完成的。而如果使用的内嵌tomcat，就跟<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>没有任何关系了。</p>

<p>网络上很多的观点是ServletContainerInitializer让SpringBoot成功初始化，我觉得他们可能粗略地跟着其他人的解析粗略看了一下源码，就草草地得了一个结论。</p>

<p>源码 SpringBoot的版本是 2.2.2.RELEASE 、Spring版本是5.2.2.RELEASE 。</p>

<p>如果观点有误，请指正！！！</p>

<h2 id="了解webxml">了解web.xml</h2>

<h3 id="webxml是什么">web.xml是什么</h3>

<p>Servlet规范要求Web容器支持<strong>部署描述文件</strong>（web.xml）。Web容器使用<strong>部署描述文件</strong>(Deployment Descriptor,DD)初始化Web应用程序的组件。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">version=</span><span class="s">"2.4"</span> 
    <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/j2ee"</span> 
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> 
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/j2ee 
    http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;display-name&gt;</span>javaWeb<span class="nt">&lt;/display-name&gt;</span> 
  <span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>CharacterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>web.filter.CharacterEncodingFilter<span class="nt">&lt;/filter-class&gt;</span>
  <span class="nt">&lt;/filter&gt;</span>
  <span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>CharacterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/filter-mapping&gt;</span>
  <span class="nt">&lt;servlet&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>UserServlet<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;servlet-class&gt;</span>cn.uhfun.demo.UserServlet<span class="nt">&lt;/servlet-class&gt;</span>
  <span class="nt">&lt;/servlet&gt;</span>
  <span class="nt">&lt;servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>UserServlet<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/user/userServlet<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/servlet-mapping&gt;</span>
  <span class="nt">&lt;welcome-file-list&gt;</span>
    <span class="nt">&lt;welcome-file&gt;</span>index.jsp<span class="nt">&lt;/welcome-file&gt;</span>
  <span class="nt">&lt;/welcome-file-list&gt;</span>
  ...
<span class="nt">&lt;/web-app&gt;</span>
</code></pre></div></div>

<p>例如上面的配置，制定了web应用的名称、过滤器（和过滤器class关联，以及指定过滤url）、servlet（和实现类关联，servlet映射）、欢迎页等。</p>

<p>Tomcat容器在部署web应用时，会在初始化阶段加载<code class="language-plaintext highlighter-rouge">web.xml</code>文件，从而加载servlet及其映射，最终能够对外提供服务。</p>

<h3 id="springmvc中的webxml">SpringMVC中的web.xml</h3>

<p>在普通的Java web应用中，我们需要开发很多的Servlet来处理不同的请求。而SpringMVC的核心思想是设计一个功能强大的Servlet（聚合了Spring容器的各种能力）作为前端控制器，协调组织不同的组件，完成请求处理和返回响应。</p>

<p><code class="language-plaintext highlighter-rouge">DispatcherServlet</code>是一个继承自<code class="language-plaintext highlighter-rouge">FrameworkServlet</code>的servlet，在源码中它是这么描述的</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
* Central dispatcher for HTTP request handlers/controllers, e.g. for web UI controllers
* or HTTP-based remote service exporters. Dispatches to registered handlers for processing
* a web request, providing convenient mapping and exception handling facilities.
 
* 用于HTTP请求处理程序/控制器的中央调度器，例如用于Web UI控制器或基于HTTP的远程服务导出器。
* 调度到注册的处理程序以处理Web请求，从而提供方便的映射和异常处理工具。
*/</span>
</code></pre></div></div>

<p>简单理解就是，它可以让我们以更加灵活便捷的方式来编写请求处理器，例如我们常见的通过注解的方式来编写处理器@controller、@RequestMapping等</p>

<p>因此它的<code class="language-plaintext highlighter-rouge">web.xml</code>中就出现了<code class="language-plaintext highlighter-rouge">DispatcherServlet</code>的字样，并且你不再需要其他的Servlet（关于DispatcherServlet的实现细节我会放在后面的文章中重点介绍）：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/javaee"</span>
        <span class="na">xmlns:web=</span><span class="s">"http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/javaee
              http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span>
    <span class="na">id=</span><span class="s">"WebApp_ID"</span> <span class="na">version=</span><span class="s">"3.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;display-name&gt;</span>Spring MVC App<span class="nt">&lt;/display-name&gt;</span>
    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>characterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="nt">&lt;/filter-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>encoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>UTF-8<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>forceEncoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>true<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>characterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>
    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>MainDispatcherServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>MainDispatcherServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</code></pre></div></div>

<h2 id="springboot中的dispatcherservlet">SpringBoot中的DispatcherServlet</h2>

<p>既然没有了<code class="language-plaintext highlighter-rouge">web.xml</code>，那SpringBoot中的<code class="language-plaintext highlighter-rouge">DispatcherServlet</code>是如何被加载的呢？</p>

<p>首先，SpringBoot提供了两种启动的方式，这两种方式在<code class="language-plaintext highlighter-rouge">注册serlvet的配置</code>时有所不同</p>

<h3 id="springboot启动方式">SpringBoot启动方式</h3>

<ol>
  <li>
    <p>使用内嵌web容器，这是比较常见的一种方式</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoSpringmvcApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">DemoSpringmvcApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>使用外部web容器</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoSpringmvcApplication</span> <span class="kd">extends</span> <span class="nc">SpringBootServletInitializer</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">SpringApplicationBuilder</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">SpringApplicationBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">sources</span><span class="o">(</span><span class="nc">DemoSpringmvcApplication</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="springboot自动加载配置原理简析">SpringBoot自动加载配置原理简析</h3>

<p>我们需要先来简单了解一下SpringBoot的加载原理</p>

<h4 id="springboot的启动">SpringBoot的启动</h4>

<p>通常SpringBoot项目都有一个启动类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoSpringmvcApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">DemoSpringmvcApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>SpringApplication的静态方法<code class="language-plaintext highlighter-rouge">run</code>会将启动类的class作为参数，构建一个SpringApplication的实例，然后调用实例的<code class="language-plaintext highlighter-rouge">run</code>方法</p>

<h4 id="创建上下文">创建上下文</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringApplication</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">primarySources</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">SpringApplication</span><span class="o">(</span><span class="n">primarySources</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
  <span class="o">}</span> 
  <span class="o">...</span>
  <span class="kd">public</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="o">...</span>
			<span class="n">context</span> <span class="o">=</span> <span class="n">createApplicationContext</span><span class="o">();</span>
			<span class="n">exceptionReporters</span> <span class="o">=</span> <span class="n">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">SpringBootExceptionReporter</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
					<span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">ConfigurableApplicationContext</span><span class="o">.</span><span class="na">class</span> <span class="o">},</span> <span class="n">context</span><span class="o">);</span>
			<span class="n">prepareContext</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">environment</span><span class="o">,</span> <span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">,</span> <span class="n">printedBanner</span><span class="o">);</span>
			<span class="n">refreshContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
			<span class="n">afterRefresh</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
			<span class="o">...</span>
			<span class="o">}</span>
			<span class="o">...</span>
		<span class="o">}</span>
		<span class="o">...</span>
	<span class="o">}</span>
  <span class="o">...</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">refreshContext</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">refresh</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
		<span class="o">...</span>
	<span class="o">}</span>
  <span class="o">...</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">AbstractApplicationContext</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">applicationContext</span><span class="o">);</span>
		<span class="o">((</span><span class="nc">AbstractApplicationContext</span><span class="o">)</span> <span class="n">applicationContext</span><span class="o">).</span><span class="na">refresh</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>调用内部的<code class="language-plaintext highlighter-rouge">protected</code>方法 <code class="language-plaintext highlighter-rouge">createApplicationContext()</code>，因为<code class="language-plaintext highlighter-rouge">webApplicationType</code>为<code class="language-plaintext highlighter-rouge">SERVLET</code>，通过反射创建了<code class="language-plaintext highlighter-rouge">org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext</code>的实例</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">createApplicationContext</span><span class="o">()</span> <span class="o">{</span>
   <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">contextClass</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationContextClass</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">contextClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="k">switch</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">webApplicationType</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">case</span> <span class="nl">SERVLET:</span>
            <span class="n">contextClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="no">DEFAULT_SERVLET_WEB_CONTEXT_CLASS</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
         <span class="k">case</span> <span class="nl">REACTIVE:</span>
            <span class="n">contextClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="no">DEFAULT_REACTIVE_WEB_CONTEXT_CLASS</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
         <span class="k">default</span><span class="o">:</span>
            <span class="n">contextClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="no">DEFAULT_CONTEXT_CLASS</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="o">...</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="o">(</span><span class="nc">ConfigurableApplicationContext</span><span class="o">)</span> <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">contextClass</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>注意！！！在构建实例时，对其中的reader和scanner进行了初始化</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">AnnotationConfigServletWebServerApplicationContext</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotatedBeanDefinitionReader</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
   <span class="k">this</span><span class="o">.</span><span class="na">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathBeanDefinitionScanner</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="注册configurationclasspostprocessor的beandefinition到容器中">注册ConfigurationClassPostProcessor的BeanDefinition到容器中</h5>

<p>在AnnotatedBeanDefinitionReader构造方法中，会调用AnnotationConfigUtils的方法将ConfigurationClassPostProcessor处理器的beanDefinition添加到容器中</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">AnnotatedBeanDefinitionReader</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="nc">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
   <span class="o">...</span>
   <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">registerAnnotationConfigProcessors</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AnnotationConfigUtils</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="nf">registerAnnotationConfigProcessors</span><span class="o">(</span>
        <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
     <span class="o">...</span>
     <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">beanDefs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="mi">8</span><span class="o">);</span>
     <span class="k">if</span> <span class="o">(!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="no">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">ConfigurationClassPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="no">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">));</span>
     <span class="o">}</span>
     <span class="o">...</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="刷新应用上下文invokebeanfactorypostprocessors">刷新应用上下文，invokeBeanFactoryPostProcessors</h4>

<p>创建完应用上下文，这时我们再回到<code class="language-plaintext highlighter-rouge">SpringApplication</code>的非静态<code class="language-plaintext highlighter-rouge">run</code>方法中的<code class="language-plaintext highlighter-rouge">refreshContext(context);</code></p>

<p>它进入<code class="language-plaintext highlighter-rouge">AbstractApplicationContext</code>的<code class="language-plaintext highlighter-rouge">refresh</code>方法，接下里会调用<code class="language-plaintext highlighter-rouge">invokeBeanFactoryPostProcessors</code>方法，执行<code class="language-plaintext highlighter-rouge">BeanFactoryPostProcessor</code>中的处理方法，因为<code class="language-plaintext highlighter-rouge">ConfigurationClassParser</code>的beanDefinition已经在容器中了，所以会被调用</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractApplicationContext</span> <span class="kd">extends</span> <span class="nc">DefaultResourceLoader</span>
		<span class="kd">implements</span> <span class="nc">ConfigurableApplicationContext</span> <span class="o">{</span>
		<span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">,</span> <span class="nc">IllegalStateException</span> <span class="o">{</span>
       <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">startupShutdownMonitor</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// 为刷新做准备，例如</span>
          <span class="c1">// 初始化上下文环境中的所有占位符属性源;验证是否所有标记为必需的属性都是可解析的</span>
          <span class="n">prepareRefresh</span><span class="o">();</span>
          <span class="c1">// 获得子类中刷新的Bean工厂</span>
          <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="o">();</span>
          <span class="c1">// 准备好在此上下文中使用的bean工厂</span>
          <span class="n">prepareBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
          <span class="k">try</span> <span class="o">{</span>
             <span class="c1">// 允许在上下文子类中对bean工厂进行后处理</span>
             <span class="n">postProcessBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
            <span class="c1">// 调用上下文中注册为bean的工厂处理器</span>
            <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
             <span class="o">...</span>
          <span class="o">}</span>
          <span class="o">...</span>
       <span class="o">}</span>
    <span class="o">}</span>		
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">PostProcessorRegistrationDelegate</span><span class="o">.</span><span class="na">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="n">getBeanFactoryPostProcessors</span><span class="o">());</span>
      <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="import-autoconfigurationimportselector">Import AutoConfigurationImportSelector</h4>

<p>解析启动类上的@SpringBootApplication、@EnableAutoConfiguration间接引入的@Import(AutoConfigurationImportSelector.class)</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Group</span><span class="o">.</span><span class="na">Entry</span><span class="o">&gt;</span> <span class="nf">getImports</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">DeferredImportSelectorHolder</span> <span class="n">deferredImport</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">deferredImports</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">group</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">deferredImport</span><span class="o">.</span><span class="na">getConfigurationClass</span><span class="o">().</span><span class="na">getMetadata</span><span class="o">(),</span>
                       <span class="n">deferredImport</span><span class="o">.</span><span class="na">getImportSelector</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">group</span><span class="o">.</span><span class="na">selectImports</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="autoconfigurationimportselector找到其他configuration并自动加载">AutoConfigurationImportSelector找到其他Configuration并自动加载</h4>

<p>AutoConfigurationImportSelector通过调用SpringFactoriesLoader的loadFactoryNames方法，找到候选的其他配置类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">AutoConfigurationEntry</span> <span class="nf">getAutoConfigurationEntry</span><span class="o">(</span><span class="nc">AutoConfigurationMetadata</span> <span class="n">autoConfigurationMetadata</span><span class="o">,</span>
      <span class="nc">AnnotationMetadata</span> <span class="n">annotationMetadata</span><span class="o">)</span> <span class="o">{</span>
   <span class="o">...</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">configurations</span> <span class="o">=</span> <span class="n">getCandidateConfigurations</span><span class="o">(</span><span class="n">annotationMetadata</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
   <span class="n">configurations</span> <span class="o">=</span> <span class="n">removeDuplicates</span><span class="o">(</span><span class="n">configurations</span><span class="o">);</span>
   <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getCandidateConfigurations</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">,</span> <span class="nc">AnnotationAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">configurations</span> <span class="o">=</span> <span class="nc">SpringFactoriesLoader</span><span class="o">.</span><span class="na">loadFactoryNames</span><span class="o">(</span><span class="n">getSpringFactoriesLoaderFactoryClass</span><span class="o">(),</span>
         <span class="n">getBeanClassLoader</span><span class="o">());</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">loadFactoryNames</code>方法会扫描所有jar包下的META-INF/spring.factories的配置</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">FACTORIES_RESOURCE_LOCATION</span> <span class="o">=</span> <span class="s">"META-INF/spring.factories"</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">loadSpringFactories</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">MultiValueMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">classLoader</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">Enumeration</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;</span> <span class="n">urls</span> <span class="o">=</span> <span class="o">(</span><span class="n">classLoader</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span>
					<span class="n">classLoader</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="no">FACTORIES_RESOURCE_LOCATION</span><span class="o">)</span> <span class="o">:</span>
					<span class="nc">ClassLoader</span><span class="o">.</span><span class="na">getSystemResources</span><span class="o">(</span><span class="no">FACTORIES_RESOURCE_LOCATION</span><span class="o">));</span>
			<span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedMultiValueMap</span><span class="o">&lt;&gt;();</span>
			<span class="k">while</span> <span class="o">(</span><span class="n">urls</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
				<span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
				<span class="nc">UrlResource</span> <span class="n">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UrlResource</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
				<span class="nc">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="nc">PropertiesLoaderUtils</span><span class="o">.</span><span class="na">loadProperties</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
				<span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">properties</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
					<span class="nc">String</span> <span class="n">factoryTypeName</span> <span class="o">=</span> <span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">()).</span><span class="na">trim</span><span class="o">();</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">factoryImplementationName</span> <span class="o">:</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">commaDelimitedListToStringArray</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()))</span> <span class="o">{</span>
						<span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">factoryTypeName</span><span class="o">,</span> <span class="n">factoryImplementationName</span><span class="o">.</span><span class="na">trim</span><span class="o">());</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Unable to load factories from location ["</span> <span class="o">+</span>
					<span class="no">FACTORIES_RESOURCE_LOCATION</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<h2 id="dispatcherservletautoconfiguration生效">DispatcherServletAutoConfiguration生效</h2>

<p>在spring-boot-autoconfigure-2.2.2.RELEASE.jar的META-INF/spring.factories中存在关于DispatcherServlet的自动配置</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Auto Configure
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
...
org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration,\
...
</code></pre></div></div>
<p>DispatcherServletAutoConfiguration配置类生效</p>

<p>DispatcherServletAutoConfiguration中有两个配置类</p>

<ul>
  <li>
    <p>DispatcherServletConfiguration</p>

    <p>通过<code class="language-plaintext highlighter-rouge">@Bean</code>注册<code class="language-plaintext highlighter-rouge">DispatcherServlet</code>的bean对象t到spring容器中</p>
  </li>
  <li>
    <p>DispatcherServletRegistrationConfiguration</p>

    <p>通过<code class="language-plaintext highlighter-rouge">@Bean</code>注册DispatcherServletRegistrationBean`的bean对象到spring容器中</p>
  </li>
</ul>

<h3 id="dispatcherservletregistrationbean是什么">DispatcherServletRegistrationBean是什么？</h3>

<p>它实现了<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>，下面是ServletContextInitializer源码的描述</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">/*</span> 
<span class="o">*</span> <span class="nc">Interface</span> <span class="n">used</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">a</span> <span class="nc">Servlet</span> <span class="mf">3.0</span><span class="o">+</span> <span class="o">{</span><span class="nd">@link</span> <span class="nc">ServletContext</span> <span class="n">context</span><span class="o">}</span>
<span class="o">*</span> <span class="n">programmatically</span><span class="o">.</span> <span class="nc">Unlike</span> <span class="o">{</span><span class="nd">@link</span> <span class="nc">WebApplicationInitializer</span><span class="o">},</span> <span class="n">classes</span> <span class="n">that</span> <span class="n">implement</span> <span class="k">this</span>
<span class="o">*</span> <span class="kd">interface</span> <span class="err">(</span><span class="nc">and</span> <span class="k">do</span> <span class="n">not</span> <span class="n">implement</span> <span class="o">{</span><span class="nd">@link</span> <span class="nc">WebApplicationInitializer</span><span class="o">})</span> <span class="n">will</span> <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">not</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="n">be</span>
<span class="o">*</span> <span class="n">detected</span> <span class="n">by</span> <span class="o">{</span><span class="nd">@link</span> <span class="nc">SpringServletContainerInitializer</span><span class="o">}</span> <span class="n">and</span> <span class="n">hence</span> <span class="n">will</span> <span class="n">not</span> <span class="n">be</span>
<span class="o">*</span> <span class="n">automatically</span> <span class="n">bootstrapped</span> <span class="n">by</span> <span class="n">the</span> <span class="nc">Servlet</span> <span class="n">container</span><span class="o">.</span>
<span class="o">*</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">*</span> <span class="nc">This</span> <span class="kd">interface</span> <span class="nc">is</span> <span class="n">designed</span> <span class="n">to</span> <span class="n">act</span> <span class="n">in</span> <span class="n">a</span> <span class="n">similar</span> <span class="n">way</span> <span class="n">to</span>
<span class="o">*</span> <span class="o">{</span><span class="nd">@link</span> <span class="nc">ServletContainerInitializer</span><span class="o">},</span> <span class="n">but</span> <span class="n">have</span> <span class="n">a</span> <span class="n">lifecycle</span> <span class="n">that</span><span class="err">'</span><span class="n">s</span> <span class="n">managed</span> <span class="n">by</span> <span class="nc">Spring</span> <span class="n">and</span>
<span class="o">*</span> <span class="n">not</span> <span class="n">the</span> <span class="nc">Servlet</span> <span class="n">container</span><span class="o">.</span>

<span class="o">*</span> <span class="err">用于以编程方式配置</span><span class="nc">Servlet</span> <span class="mf">3.0</span><span class="o">+{</span><span class="nd">@link</span> <span class="nc">ServletContext</span> <span class="nc">Context</span><span class="o">}</span><span class="err">的接口。</span>
<span class="o">*</span> <span class="err">与</span><span class="o">{</span><span class="nd">@link</span> <span class="nc">WebApplicationInitializer</span><span class="o">}</span><span class="err">不同，</span>
<span class="o">*</span> <span class="err">实现此接口</span><span class="o">(</span><span class="err">且不实现</span><span class="o">{</span><span class="nd">@link</span> <span class="nc">WebApplicationInitializer</span><span class="o">})</span><span class="err">的类不会被</span><span class="o">{</span><span class="nd">@link</span> <span class="nc">SpringServletContainerInitializer</span><span class="o">}</span><span class="err">检测到，</span>
<span class="o">*</span> <span class="err">因此不会由</span><span class="n">Servlet</span><span class="err">容器自动引导。此接口的设计方式与</span><span class="o">{</span><span class="nd">@link</span> <span class="nc">ServletContainerInitializer</span><span class="o">}</span><span class="err">类似，但其生命周期由</span><span class="n">Spring</span><span class="err">管理，而不是</span><span class="n">Servlet</span><span class="err">容器</span>
</code></pre></div></div>

<h4 id="注册servlet的配置">注册servlet的配置</h4>

<p>在<code class="language-plaintext highlighter-rouge">applicationContext</code>的<code class="language-plaintext highlighter-rouge">onRefresh</code>阶段会执行ServletContextInitializer.onStartup</p>

<p>SpringBoot根据内嵌还是外部的web容器有不同的操作</p>

<p>如果<code class="language-plaintext highlighter-rouge">webServer == null &amp;&amp; servletContext == null</code>为<code class="language-plaintext highlighter-rouge">true</code>则使用内嵌的tomcat</p>

<p>使用外部web容器时直接调用 ServletContextInitializer的onStartup方法，最终调用的其实就是前面注册到容器中的<code class="language-plaintext highlighter-rouge">DispatcherServletRegistrationBean</code></p>

<p>而使用内嵌容器，<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>会在获取内嵌web容器，然后容器启动后被启动（调用onStarup方法）</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServletWebServerApplicationContext</span> <span class="kd">extends</span> <span class="nc">GenericWebApplicationContext</span>
		<span class="kd">implements</span> <span class="nc">ConfigurableWebServerApplicationContext</span> <span class="o">{</span>
		<span class="o">...</span>
		<span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRefresh</span><span class="o">()</span> <span class="o">{</span>
       <span class="kd">super</span><span class="o">.</span><span class="na">onRefresh</span><span class="o">();</span>
       <span class="k">try</span> <span class="o">{</span>
          <span class="n">createWebServer</span><span class="o">();</span>
       <span class="o">}</span>
       <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Unable to start web server"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
       <span class="o">}</span>
    <span class="o">}</span>		
    <span class="o">...</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createWebServer</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">WebServer</span> <span class="n">webServer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">webServer</span><span class="o">;</span>
      <span class="nc">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">webServer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">servletContext</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ServletWebServerFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">getWebServerFactory</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">webServer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getWebServer</span><span class="o">(</span><span class="n">getSelfInitializer</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">servletContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">getSelfInitializer</span><span class="o">().</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">ServletException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Cannot initialize servlet context"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">initPropertySources</span><span class="o">();</span>
    <span class="o">}</span>
		<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="为什么外部web容器启动时servletcontext不为null"><strong>为什么外部web容器启动时servletContext不为null</strong></h4>

<p>首先这里需要先提到一个接口<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>  
    <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>Servlet3.0提供了这个接口，在web容器启动时可以让第三方组件机做一些初始化的工作</p>

  <p>ServletContainerInitializer(SCI)通过文件META-INF/services/javax.servlet.ServletContainerInitializer中的条目注册，该条目必须包含在包含SCI实现的JAR文件中。</p>

  <p>SCI类中的{@link javax.servlet.nortation.HandlesTypes}注解可以作为参数</p>
</blockquote>

<p>可以查看依赖 Maven:org.springframework:spring-web:5.2.2.RELEASE 的META-INF/services 中有一个javax.servlet.ServletContainerInitializer文件，它指定了一个ServletContainerInitializer实现类</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>org.springframework.web.SpringServletContainerInitializer
</code></pre></div></div>

<p>查看<code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>源码可以发现，web容器启动后，所有继承自WebApplicationInitializer的类都会启动</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@HandlesTypes</span><span class="o">(</span><span class="nc">WebApplicationInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringServletContainerInitializer</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">webAppInitializerClasses</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
     <span class="nc">List</span><span class="o">&lt;</span><span class="nc">WebApplicationInitializer</span><span class="o">&gt;</span> <span class="n">initializers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">webAppInitializerClasses</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">waiClass</span> <span class="o">:</span> <span class="n">webAppInitializerClasses</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">(!</span><span class="n">waiClass</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Modifier</span><span class="o">.</span><span class="na">isAbstract</span><span class="o">(</span><span class="n">waiClass</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
                 <span class="nc">WebApplicationInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">waiClass</span><span class="o">))</span> <span class="o">{</span>
              <span class="k">try</span> <span class="o">{</span>
                 <span class="n">initializers</span><span class="o">.</span><span class="na">add</span><span class="o">((</span><span class="nc">WebApplicationInitializer</span><span class="o">)</span>
                       <span class="nc">ReflectionUtils</span><span class="o">.</span><span class="na">accessibleConstructor</span><span class="o">(</span><span class="n">waiClass</span><span class="o">).</span><span class="na">newInstance</span><span class="o">());</span>
              <span class="o">}</span>
              <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServletException</span><span class="o">(</span><span class="s">"Failed to instantiate WebApplicationInitializer class"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
              <span class="o">}</span>
           <span class="o">}</span>
        <span class="o">}</span>
     <span class="o">}</span>
     <span class="o">...</span>
     <span class="k">for</span> <span class="o">(</span><span class="nc">WebApplicationInitializer</span> <span class="n">initializer</span> <span class="o">:</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">initializer</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
     <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>因为我们自定义启动类 <code class="language-plaintext highlighter-rouge">DemoSpringmvcApplication</code> 继承自<code class="language-plaintext highlighter-rouge">SpringBootServletInitializer（SpringBootServletInitializer继承自WebApplicationInitializer）</code>所以会启动</p>

<p>SpringBootServletInitializer启动后，SpringApplicationBuilder设置了initializers，new了一个ServletContextApplicationContextInitializer，里面包含了外部web容器的servletContext。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">WebApplicationContext</span> <span class="nf">createRootApplicationContext</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">SpringApplicationBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">createSpringApplicationBuilder</span><span class="o">();</span>
	 <span class="o">...</span>
   <span class="n">builder</span><span class="o">.</span><span class="na">initializers</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServletContextApplicationContextInitializer</span><span class="o">(</span><span class="n">servletContext</span><span class="o">));</span>
   <span class="o">...</span>
   <span class="k">return</span> <span class="nf">run</span><span class="o">(</span><span class="n">application</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>在前面提到的<code class="language-plaintext highlighter-rouge">springApplication.run</code>方法中的<code class="language-plaintext highlighter-rouge">prepareContext(context, environment, listeners, applicationArguments, printedBanner);</code></p>

<p>当运行到这里时，会执行初始化器的应用，应用后servletContext就被集成到了applicationContext</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">prepareContext</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">,</span>
      <span class="nc">SpringApplicationRunListeners</span> <span class="n">listeners</span><span class="o">,</span> <span class="nc">ApplicationArguments</span> <span class="n">applicationArguments</span><span class="o">,</span> <span class="nc">Banner</span> <span class="n">printedBanner</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">context</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
   <span class="n">postProcessApplicationContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
   <span class="n">applyInitializers</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
   <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>所以可以通过在<code class="language-plaintext highlighter-rouge">applicationContext onRefresh</code>阶段<code class="language-plaintext highlighter-rouge">servletContext</code>是否为空来判断是何种方式启动的</p>

<h2 id="总结">总结</h2>

<p>SpringBoot有一个关于DispatcherServlet的配置类，DispatcherServlet和DispatcherServletRegistrationBean作为bean注册到了容器中，而servlet配置注册的关键是DispatcherServletRegistrationBean（实现了<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>接口）调用<code class="language-plaintext highlighter-rouge">onStarup</code>方法。</p>


  </div>
  <div class='post-footer'><a class='post-previous' href="/uhfun-jekyll/tech/2020/05/13/Springfox%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3.html">
      <i class="fa fa-chevron-left" aria-hidden="true"></i>
      Springfox参考文档
    </a><a class='post-next' href="/uhfun-jekyll/tech/2020/05/22/%E5%82%BB%E5%82%BB%E5%88%86%E4%B8%8D%E6%B8%85-ServletContainerInitializer-SpringServletContainerInitializer-WebApplicationInitializer-SpringBootServletInitializer-ServletContextInitializer%E9%83%BD%E6%98%AF%E4%BA%9B%E5%95%A5.html">
      傻傻分不清，servletcontainerinitializer、springservletcontainerinitializer、webapplicationinitializer、springbootservletinitializer、servletcontextinitializer都是些啥
      <i class="fa fa-chevron-right" aria-hidden="true"></i>
    </a></div>
</article><div id='utterances' class="utterances-comments-header">
  <div>
    <div><strong></strong><a target="_blank" href="https://utteranc.es/">&nbsp;Utterances&nbsp;</a></strong>驱动</div>    
  </div><div><a target="_blank" href="https://github.com/uhfun/Uhfun-Jekyll/issues?q=SpringBoot项目中web.xml去哪了 | UhfunBlog"><strong>issue</strong></a></div>  
</div><script src="https://utteranc.es/client.js"
        repo= "uhfun/Uhfun-Jekyll"
        issue-term="og:title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  </div>
</article>

    </div>
  </div><footer class="footer">
  <div class="container">
    <div class="content has-text-centered">          
      <p><a href="https://uhfun.cn/tech/2020/05/22/SpringBoot%E9%A1%B9%E7%9B%AE%E4%B8%ADweb.xml%E5%8E%BB%E5%93%AA%E4%BA%86.html">Github Pages</a>&nbsp;|&nbsp;<a href="https://uhfun.gitee.io/uhfun-jekyll/tech/2020/05/22/SpringBoot%E9%A1%B9%E7%9B%AE%E4%B8%ADweb.xml%E5%8E%BB%E5%93%AA%E4%BA%86.html">Gitee Pages</a>&nbsp;|&nbsp;<a href="https://www.uhfun.cn/tech/2020/05/22/SpringBoot%E9%A1%B9%E7%9B%AE%E4%B8%ADweb.xml%E5%8E%BB%E5%93%AA%E4%BA%86.html">Vps Pages</a><br>
        Copyright © Uhfun Blog 2019<br>
        Powered by <strong> <a target="_blank" href="https://github.com/jekyll/jekyll">Jekyll</a></strong>
        &nbsp;|&nbsp;Themed by <strong> <a target="_blank" href="https://github.com/uhfun/Uhfun-Jekyll">Uhfun-Jekyll</a></strong> 
        &nbsp; <br> licensed <a target="_blank" href="https://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a></a>.
        &nbsp;
      </p>
    </div>
  </div>
</footer>
<div class="back-to-top is-info">
    <a class="icon-stack">
        <ion-icon name="arrow-dropup">
            <svg class="svg-icon">
                <use xlink:href="/uhfun-jekyll/assets/arrow-dropup.svg"></use>
            </svg>
        </ion-icon>
        <span class="back-to-top-text">Top</span>
    </a>
</div>
<script src="/uhfun-jekyll/assets/js/back-to-top.js"></script>
<script src="/uhfun-jekyll/assets/js/drop-down.js"></script>
<script async src="/uhfun-jekyll/assets/js/category-post-num.js"></script>
<script async src="/uhfun-jekyll/assets/js/baidu-push.js"></script>
<script src="/uhfun-jekyll/assets/js/360-push.js"></script>
<script async src="/uhfun-jekyll/assets/js/toc.js"></script>
<script async src="/uhfun-jekyll/assets/js/gcse.js"></script>   
<!-- <script async src="https://cse.google.com/cse.js?cx=008845838503066136412:qlzdwp3e2z8"></script> --></body>
<script src="/uhfun-jekyll/assets/js/date-format.js"></script>
</html>