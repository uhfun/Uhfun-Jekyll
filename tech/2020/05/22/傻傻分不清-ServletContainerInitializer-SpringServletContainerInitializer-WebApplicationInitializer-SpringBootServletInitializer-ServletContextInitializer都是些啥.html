<!DOCTYPE html>
<html lang="zh-CN"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="傅杭波, Uhfun傅杭波, Uhfun, UhfunBlog, Hbson傅杭波, Hb, Hbson, 博客, 个人网站, 互联网, 后端, Web, Java, Spring, 翻唱, 唱歌">
  <meta name="description" content='代码与生活、热爱唱歌的boy | 傅杭波的个人博客'>
  <meta name="robots" content="all">
  <meta property="og:type" content="post" /><meta property="og:title" content="傻傻分不清，ServletContainerInitializer、SpringServletContainerInitializer、WebApplicationInitializer、SpringBootServletInitializer、ServletContextInitializer都是些啥 | UhfunBlog" />
  <meta property="og:image" content='https://uhfun.cn/assets/img/avatar.png' />
  <meta property="og:type" content="article">
  <meta property="og:description" content="这几个类乍一看有点像，仔细一看还是有点像，特别是ServletContainerInitializer和ServletContextInitializer，眼神不好的可能还真看不出来。那它们之间到底有什么区别呢？它们之间有什么联系吗？

"><meta property="article:published_time" content='2020-05-22T16:10:00Z'><meta property="article:author" content="傅杭波"><meta property="og:image" content="" >
  <meta property="og:url" content="https://uhfun.cn/tech/2020/05/22/%E5%82%BB%E5%82%BB%E5%88%86%E4%B8%8D%E6%B8%85-ServletContainerInitializer-SpringServletContainerInitializer-WebApplicationInitializer-SpringBootServletInitializer-ServletContextInitializer%E9%83%BD%E6%98%AF%E4%BA%9B%E5%95%A5.html"><meta property="article:tag" content="SpringBoot"><meta property="article:tag" content="SpringMVC"><meta property="article:tag" content="Spring"><meta property="og:site_name" content="傅杭波的博客UhfunBlog" />
  <meta name="baidu-site-verification" content= "9DYfdd4yEo" />
  <meta name="google-site-verification" content="uDSkqT9lEtkk2RsKYeldTKkmr4u_yI5aR3Y-tGgjcBo" />
  <title>傻傻分不清，ServletContainerInitializer、SpringServletContainerInitializer、WebApplicationInitializer、SpringBootServletInitializer、ServletContextInitializer都是些啥 | UhfunBlog</title>
  <!-- Favicon -->
  <link rel="shortcut icon" href="/assets/img/favicon.ico">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/assets/css/main.css"><link type="application/atom+xml" rel="alternate" href="https://uhfun.cn/feed.xml" title="UhfunBlog" /><script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/font-awesome/5.11.2/js/all.min.js"></script>
</head><body><header class="navbar has-shadow is-spaced" role="banner">
  <div class="container"><div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img src='/assets/img/logo.png' width="160">
      </a>
      <div role="button" class="navbar-burger burger" data-target="navbarExampleTransparentExample">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </div>
    </div>
    <div class="navbar-menu">
      <div class="navbar-end">
        <a class='navbar-item' href='/'>主页</a><a class="navbar-item" href="/README.html">自述
        </a><a class="navbar-item" href="/tag/">标签
        </a><a class="navbar-item" href="/life/">生活
        </a><a class="navbar-item" href="/tech/">技术
        </a><div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
              <img class="is-rounded" src='/assets/img/avatar.png'>
          </a>
          <div class="navbar-dropdown is-right">
            <a class="icon-dropdown navbar-item" href="/about.html">
              <i class="far fa-user" aria-hidden="true"></i> 关于
            </a>
            <a class="icon-dropdown navbar-item" href="https://github.com/uhfun">
              <i class="fab fa-github" aria-hidden="true"></i> Github
            </a>
            <hr class="navbar-divider">
            <a class="navbar-item" href="/README.html#utterances"> 报告问题
            </a>
          </div>
        </div>
      </div>
    </div></div>
</header>
<div class="section">
    <div class="container">
      <article class="page">
  <div class="content">
    <article class="post"><h1 class="title is-spaced">傻傻分不清，ServletContainerInitializer、SpringServletContainerInitializer、WebApplicationInitializer、SpringBootServletInitializer、ServletContextInitializer都是些啥</h1><div class="tags">
    <div class="container"><span class="icon is-small">
            <i class="fa fa-tags" aria-hidden="true"></i>
        </span><a href="/tag/springboot">SpringBoot</a><a href="/tag/springmvc">SpringMVC</a><a href="/tag/spring">Spring</a>
        <span class="spot">•</span>
        <span class='formated-date' data-time="2020/05/22 16:10:00">
            2020-05-22
        </span><span class="spot">•</span>
        <span>17分钟
        </span></div>
</div><div class='post-img'></div><div class="article_license">
      <p>
        <strong>版权声明：本文为博主原创文章，遵循</strong> 
        <a target="_blank" href="http://creativecommons.org/licenses/by-sa/4.0/">CC 4.0 BY-SA</a>       
        <strong>版权协议，转载请附上原文出处链接和本声明。</strong>    
        <br>    
        <strong>本文链接：</strong> 
        <a target="_blank" href="https://uhfun.cn/tech/2020/05/22/傻傻分不清-ServletContainerInitializer-SpringServletContainerInitializer-WebApplicationInitializer-SpringBootServletInitializer-ServletContextInitializer都是些啥.html">https://uhfun.cn/tech/2020/05/22/傻傻分不清-ServletContainerInitializer-SpringServletContainerInitializer-WebApplicationInitializer-SpringBootServletInitializer-ServletContextInitializer都是些啥.html</a>        
      </p>
    </div><div class='post-content'>
    <div id="toc"></div><p>这几个类乍一看有点像，仔细一看还是有点像，特别是<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>和<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>，眼神不好的可能还真看不出来。那它们之间到底有什么区别呢？它们之间有什么联系吗？</p>

<h2 id="全限定名">全限定名</h2>

<p>首先我们先来看一下它们的全限定名</p>

<ul>
  <li>
    <p><strong>ServletContainerInitializer</strong>（<code class="language-plaintext highlighter-rouge">javax.servlet.ServletContainerInitializer</code>）</p>
  </li>
  <li>
    <p><strong>SpringServletContainerInitializer</strong>（<code class="language-plaintext highlighter-rouge">org.springframework.web.SpringServletContainerInitializer</code>）</p>
  </li>
  <li>
    <p><strong>WebApplicationInitializer</strong>（<code class="language-plaintext highlighter-rouge">org.springframework.web.WebApplicationInitializer</code>）</p>
  </li>
  <li>
    <p><strong>SpringBootServletInitializer</strong>（<code class="language-plaintext highlighter-rouge">org.springframework.boot.web.servlet.support.SpringBootServletInitializer</code>）</p>
  </li>
  <li>
    <p><strong>ServletContextInitializer</strong>（<code class="language-plaintext highlighter-rouge">org.springframework.boot.web.servlet.ServletContextInitializer</code>）</p>
  </li>
</ul>

<h2 id="servletcontainerinitializer">ServletContainerInitializer</h2>

<h3 id="servletcontainerinitializer是什么">ServletContainerInitializer是什么</h3>

<p>因为这个不是spring家族的，我们就先来讲一下这个类</p>

<p><code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>是servlet3.0规范中引入的接口，能够让web应用程序在servlet容器启动后做一些自定义的操作。</p>

<p><a href="https://javaee.github.io/javaee-spec/javadocs/javax/servlet/ServletContainerInitializer.html">ServletContainerInitializer</a> 基于服务提供者接口（SPI）概念，因此你需要在你的<code class="language-plaintext highlighter-rouge">jar</code>包目录下添加<code class="language-plaintext highlighter-rouge">META-INF/services/javax.servlet.ServletContainerInitializer</code>文件，内容就是<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>实现类的全限定名。</p>

<blockquote>
  <p>例如在 <code class="language-plaintext highlighter-rouge">org.springframework:spring-web</code>的<code class="language-plaintext highlighter-rouge">META-INF/services</code>中存在 <code class="language-plaintext highlighter-rouge">javax.servlet.ServletContainerInitializer</code>文件，它的内容就是springMVC提供的实现类 <code class="language-plaintext highlighter-rouge">org.springframework.web.SpringServletContainerInitializer</code></p>
</blockquote>

<h3 id="servletcontainerinitializer怎么用">ServletContainerInitializer怎么用</h3>

<p>ServletContainerInitializer`只有一个方法</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">javax</span><span class="o">.</span><span class="na">servlet</span><span class="o">;</span>
<span class="o">...</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ServletContainerInitializer#onStartup</code>方法由Servlet容器调用(必须至少支持Servlet 3.0版本)。我们在这个方法中通过编程的方式去注册<code class="language-plaintext highlighter-rouge">Servlet</code> <code class="language-plaintext highlighter-rouge">Filter</code> <code class="language-plaintext highlighter-rouge">Listenner</code>等组件，代替<code class="language-plaintext highlighter-rouge">web.xml</code>。</p>

<p>可以配合 <a href="https://javaee.github.io/javaee-spec/javadocs/javax/servlet/annotation/HandlesTypes.html"><code class="language-plaintext highlighter-rouge">@HandleTypes</code></a> 注解，通过指定Class，容器会把所有的指定类的子类作为方法<code class="language-plaintext highlighter-rouge">onStartup</code> 的参数<code class="language-plaintext highlighter-rouge">Set&lt;Class&lt;?&gt;&gt; c</code>传递进来</p>

<blockquote>
  <p>例如<code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>传递了spring自定义的<code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code></p>

  <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">;</span>
<span class="o">...</span>
<span class="nd">@HandlesTypes</span><span class="o">(</span><span class="nc">WebApplicationInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringServletContainerInitializer</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="springservletcontainerinitializer和webapplicationinitializer">SpringServletContainerInitializer和WebApplicationInitializer</h2>

<p>我们就接着前面的例子，来讲<code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>，那为什么和<code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code>一起讲呢？</p>

<h3 id="springservletcontainerinitializer是什么">SpringServletContainerInitializer是什么</h3>

<p>根据名字不难看出，它比<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>多了<code class="language-plaintext highlighter-rouge">Spring</code> 的前缀，顾名思义 它是Spring提供的<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>的实现类</p>

<h3 id="webapplicationinitializer是什么">WebApplicationInitializer是什么</h3>

<p><code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code>是Spring提供的接口，和<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>没有直接关系，但是和它有间接关系。<code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code>在<code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>中实例化后被调用。</p>

<h3 id="springservletcontainerinitializer和webapplicationinitializer的关系">SpringServletContainerInitializer和WebApplicationInitializer的关系</h3>

<p>它们之间的关系可以理解为，<code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>实现了servlet容器提供的接口带了个头，接下来的事可以交由 spring自己定义的<code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code></p>

<p><code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>源码如下，可以看到，<code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>将传入的 <code class="language-plaintext highlighter-rouge">webAppInitializerClasses</code> 通过反射实例化，然后根据<code class="language-plaintext highlighter-rouge">@Order</code>注解排序后，依次调用</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@HandlesTypes</span><span class="o">(</span><span class="nc">WebApplicationInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringServletContainerInitializer</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">webAppInitializerClasses</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span>
         <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">WebApplicationInitializer</span><span class="o">&gt;</span> <span class="n">initializers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">webAppInitializerClasses</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">waiClass</span> <span class="o">:</span> <span class="n">webAppInitializerClasses</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">waiClass</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Modifier</span><span class="o">.</span><span class="na">isAbstract</span><span class="o">(</span><span class="n">waiClass</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
                  <span class="nc">WebApplicationInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">waiClass</span><span class="o">))</span> <span class="o">{</span>
               <span class="k">try</span> <span class="o">{</span>
                  <span class="n">initializers</span><span class="o">.</span><span class="na">add</span><span class="o">((</span><span class="nc">WebApplicationInitializer</span><span class="o">)</span>
                        <span class="nc">ReflectionUtils</span><span class="o">.</span><span class="na">accessibleConstructor</span><span class="o">(</span><span class="n">waiClass</span><span class="o">).</span><span class="na">newInstance</span><span class="o">());</span>
               <span class="o">}</span>
               <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServletException</span><span class="o">(</span><span class="s">"Failed to instantiate WebApplicationInitializer class"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
               <span class="o">}</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">initializers</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
         <span class="n">servletContext</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="s">"No Spring WebApplicationInitializer types detected on classpath"</span><span class="o">);</span>
         <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">servletContext</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">initializers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">" Spring WebApplicationInitializers detected on classpath"</span><span class="o">);</span>
      <span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">initializers</span><span class="o">);</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">WebApplicationInitializer</span> <span class="n">initializer</span> <span class="o">:</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">initializer</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="springservletcontainerinitializer和webapplicationinitializer怎么用">SpringServletContainerInitializer和WebApplicationInitializer怎么用</h3>

<p>我们可以使用<code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code>接口来代替<code class="language-plaintext highlighter-rouge">web.xml</code>配置</p>

<h4 id="继承abstractannotationconfigdispatcherservletinitializer">继承AbstractAnnotationConfigDispatcherServletInitializer</h4>

<p>例如我们自定义一个类，继承Spring为我们提供的<code class="language-plaintext highlighter-rouge">AbstractAnnotationConfigDispatcherServletInitializer</code>,不需要添加@Configuration等注解，因为Servlet容器会自动将我们自定义的<code class="language-plaintext highlighter-rouge">MyCustomWebApplicationInitializer</code> class传入<code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer#onStartup</code>，而<code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>会为我们实例化这个类并调用它。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCustomWebApplicationInitializer</span> <span class="kd">extends</span> <span class="nc">AbstractAnnotationConfigDispatcherServletInitializer</span> <span class="o">{</span>

    <span class="cm">/**
     * 为{@linkPlan#createRootApplicationContext()根应用程序上下文}
     * 指定{@code@Configuration}和/或{@code@Component}类
     * @ 返回根应用上下文的配置，如果不需要创建和注册根上下文，则返回{@code null
     */</span>
    <span class="nd">@Nullable</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">getRootConfigClasses</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     *  为{@linkPlan#createServletApplicationContext()Servlet应用程序上下文}指定
     * {@code@Configuration}和/或{@code@Component}类
     * @返回Servlet应用程序上下文的配置，或者如果所有配置都通过根配置类指定，则为{@code null}
     */</span>
    <span class="nd">@Nullable</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">getServletConfigClasses</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]{</span><span class="nc">WebConfig</span><span class="o">.</span><span class="na">class</span><span class="o">};</span>
    <span class="o">}</span>

    <span class="cm">/**
    * 指定{@code DispatcherServlet}的Servlet映射
    * 例如{@code“/”}、{@code“/app”}等
    */</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">getServletMappings</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"/"</span><span class="o">};</span>
    <span class="o">}</span>

    <span class="cm">/**
    * 返回注册{@link DispatcherServlet}的名称
    * 默认为{@link#Default_Servlet_Name} (public static final String DEFAULT_SERVLET_NAME = "dispatcher";)
    */</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">getServletName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"myCustomServletName"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="自己实现webapplicationinitializer">自己实现WebApplicationInitializer</h4>

<p>同样，我们可以实现一个简单版的<code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code>，效果也是一样的。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleWebApplicationInitializer</span> <span class="kd">implements</span> <span class="nc">WebApplicationInitializer</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">AnnotationConfigWebApplicationContext</span> <span class="n">webContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigWebApplicationContext</span><span class="o">();</span>
        <span class="n">servletContext</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ContextLoaderListener</span><span class="o">(</span><span class="n">webContext</span><span class="o">));</span>
        <span class="n">webContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">WebConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">ServletRegistration</span><span class="o">.</span><span class="na">Dynamic</span> <span class="n">registration</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="na">addServlet</span><span class="o">(</span><span class="s">"myCustomServletName"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DispatcherServlet</span><span class="o">(</span><span class="n">webContext</span><span class="o">));</span>
        <span class="n">registration</span><span class="o">.</span><span class="na">setLoadOnStartup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">registration</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="springbootservletinitializer">SpringBootServletInitializer</h2>

<h3 id="springbootservletinitializer是什么">SpringBootServletInitializer是什么</h3>

<p>同样从名字中我们可以大致猜到，它是<code class="language-plaintext highlighter-rouge">SpringBoot</code>提供的，<code class="language-plaintext highlighter-rouge">SpringBoot</code> 替我们实现了一些功能</p>

<p>它是一个抽象类，实现了<code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code>接口，注意不是Servlet3.0规范提供的那个接口，是<code class="language-plaintext highlighter-rouge">Spring</code>提供的自家初始化接口，你问我它是做什么的？那我们不如来看看源码是怎么说的</p>

<blockquote>
  <p>这是一个固执己见的 <code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code> 让我们可以使用传统的WAR包的方式部署运行 <code class="language-plaintext highlighter-rouge">SpringApplication</code>，可以将 <code class="language-plaintext highlighter-rouge">servlet</code>、<code class="language-plaintext highlighter-rouge">filter</code> 和 <code class="language-plaintext highlighter-rouge">ServletContextInitializer</code> 从应用程序上下文绑定到服务器。</p>

  <p>如果要配置应用程序，要么覆盖 <code class="language-plaintext highlighter-rouge">configure(SpringApplicationBuilder)</code> 方法(调用 <code class="language-plaintext highlighter-rouge">SpringApplicationBuilder#Sources(Class.)</code>)，要么使初始化式本身成为 <code class="language-plaintext highlighter-rouge">@configuration</code>。如果将<code class="language-plaintext highlighter-rouge">SpringBootServletInitializer</code>与其他 <code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code> 结合使用，则可能还需要添加<code class="language-plaintext highlighter-rouge">@Ordered</code>注解来配置特定的启动顺序。</p>

  <p>请注意，只有在构建和部署WAR文件时才需要WebApplicationInitializer。如果您更喜欢运行嵌入式Web服务器，那么您根本不需要这个。</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * An opinionated {@link WebApplicationInitializer} to run a {@link SpringApplication}
 * from a traditional WAR deployment. Binds {@link Servlet}, {@link Filter} and
 * {@link ServletContextInitializer} beans from the application context to the server.
 * &lt;p&gt;
 * To configure the application either override the
 * {@link #configure(SpringApplicationBuilder)} method (calling
 * {@link SpringApplicationBuilder#sources(Class...)}) or make the initializer itself a
 * {@code @Configuration}. If you are using {@link SpringBootServletInitializer} in
 * combination with other {@link WebApplicationInitializer WebApplicationInitializers} you
 * might also want to add an {@code @Ordered} annotation to configure a specific startup
 * order.
 * &lt;p&gt;
 * Note that a WebApplicationInitializer is only needed if you are building a war file and
 * deploying it. If you prefer to run an embedded web server then you won't need this at
 * all.
 *
 * @author Dave Syer
 * @author Phillip Webb
 * @author Andy Wilkinson
 * @since 2.0.0
 * @see #configure(SpringApplicationBuilder)
 */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SpringBootServletInitializer</span> <span class="kd">implements</span> <span class="nc">WebApplicationInitializer</span> <span class="o">{</span>
</code></pre></div></div>

<p>这些话简单来讲什么意思呢？</p>

<p>它是说，如果你需要使用外部容器，打war包然后部署，那么你需要继承这个类然后重写<code class="language-plaintext highlighter-rouge">configure</code>方法，像这个样子</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoSpringmvcApplication</span> <span class="kd">extends</span> <span class="nc">SpringBootServletInitializer</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="nc">SpringApplicationBuilder</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">SpringApplicationBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">sources</span><span class="o">(</span><span class="nc">DemoSpringmvcApplication</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>如果你觉得内嵌的tomcat挺好用的，那么你就当什么事情都没有发生</p>

<h3 id="springbootservletinitializer怎么运作的">SpringBootServletInitializer怎么运作的</h3>

<p>首先你要知道，它是一个 <code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code>，它的启动靠的是 <code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>，</p>

<p>而 <code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>靠的是Servlet容器。所以它的启动靠的就是外部容器。</p>

<p>因此当外部容器启动时，会调用<code class="language-plaintext highlighter-rouge">SpringBootServletInitializer#onStartup</code></p>

<p>那我们来看看它的 <code class="language-plaintext highlighter-rouge">onStartup</code> 方法里做了什么，它首先调用 <code class="language-plaintext highlighter-rouge">createRootApplicationContext</code>来创建web应用上下文</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">logger</span> <span class="o">=</span> <span class="nc">LogFactory</span><span class="o">.</span><span class="na">getLog</span><span class="o">(</span><span class="n">getClass</span><span class="o">());</span>
   <span class="nc">WebApplicationContext</span> <span class="n">rootAppContext</span> <span class="o">=</span> <span class="n">createRootApplicationContext</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">rootAppContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">servletContext</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ContextLoaderListener</span><span class="o">(</span><span class="n">rootAppContext</span><span class="o">)</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextInitialized</span><span class="o">(</span><span class="nc">ServletContextEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// no-op because the application context is already initialized</span>
         <span class="o">}</span>
      <span class="o">});</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"No ContextLoaderListener registered, as createRootApplicationContext() did not "</span>
            <span class="o">+</span> <span class="s">"return an application context"</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>再来看 <code class="language-plaintext highlighter-rouge">createRootApplicationContext</code> 方法</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">WebApplicationContext</span> <span class="nf">createRootApplicationContext</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">SpringApplicationBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">createSpringApplicationBuilder</span><span class="o">();</span>
   <span class="n">builder</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">getClass</span><span class="o">());</span>
   <span class="nc">ApplicationContext</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">getExistingRootWebApplicationContext</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">parent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Root context already created (using as parent)."</span><span class="o">);</span>
      <span class="n">servletContext</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">WebApplicationContext</span><span class="o">.</span><span class="na">ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">initializers</span><span class="o">(</span><span class="k">new</span> <span class="nc">ParentContextApplicationContextInitializer</span><span class="o">(</span><span class="n">parent</span><span class="o">));</span>
   <span class="o">}</span>
   <span class="n">builder</span><span class="o">.</span><span class="na">initializers</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServletContextApplicationContextInitializer</span><span class="o">(</span><span class="n">servletContext</span><span class="o">));</span>
   <span class="n">builder</span><span class="o">.</span><span class="na">contextClass</span><span class="o">(</span><span class="nc">AnnotationConfigServletWebServerApplicationContext</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">builder</span> <span class="o">=</span> <span class="n">configure</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
   <span class="n">builder</span><span class="o">.</span><span class="na">listeners</span><span class="o">(</span><span class="k">new</span> <span class="nc">WebEnvironmentPropertySourceInitializer</span><span class="o">(</span><span class="n">servletContext</span><span class="o">));</span>
   <span class="nc">SpringApplication</span> <span class="n">application</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">application</span><span class="o">.</span><span class="na">getAllSources</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">()</span>
         <span class="o">&amp;&amp;</span> <span class="nc">MergedAnnotations</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">getClass</span><span class="o">(),</span> <span class="nc">SearchStrategy</span><span class="o">.</span><span class="na">TYPE_HIERARCHY</span><span class="o">).</span><span class="na">isPresent</span><span class="o">(</span><span class="nc">Configuration</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">application</span><span class="o">.</span><span class="na">addPrimarySources</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="n">getClass</span><span class="o">()));</span>
   <span class="o">}</span>
   <span class="nc">Assert</span><span class="o">.</span><span class="na">state</span><span class="o">(!</span><span class="n">application</span><span class="o">.</span><span class="na">getAllSources</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">(),</span>
         <span class="s">"No SpringApplication sources have been defined. Either override the "</span>
               <span class="o">+</span> <span class="s">"configure method or add an @Configuration annotation"</span><span class="o">);</span>
   <span class="c1">// Ensure error pages are registered</span>
   <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registerErrorPageFilter</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">application</span><span class="o">.</span><span class="na">addPrimarySources</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="nc">ErrorPageFilterConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="nf">run</span><span class="o">(</span><span class="n">application</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>
    <p>如果有父级应用上下文，设置一个初始化器<code class="language-plaintext highlighter-rouge">ParentContextApplicationContextInitializer</code>，这个初始化器会在<code class="language-plaintext highlighter-rouge">ConfigurableApplicationContext#refresh()</code> 刷新之前设置父级应用上下文并添加事件监听</p>
  </li>
  <li>
    <p>设置一个servletContext初始化的初始化器，同样会在 <code class="language-plaintext highlighter-rouge">ConfigurableApplicationContext#refresh()</code>刷新之前将<code class="language-plaintext highlighter-rouge">servletContext</code>添加到应用上下文中</p>
  </li>
  <li>
    <p>设置上下文类型，AnnotationConfigServletWebServerApplicationContext</p>
  </li>
  <li>
    <p>向此应用程序添加更多源(配置类<code class="language-plaintext highlighter-rouge">@Configuration</code>和组件<code class="language-plaintext highlighter-rouge">@Component</code>)。</p>

    <blockquote>
      <p>例如上面启动类重写的<code class="language-plaintext highlighter-rouge">configure</code>，就是将我们的<code class="language-plaintext highlighter-rouge">DemoSpringmvcApplication</code>作为配置类添加到了源中，好让启动后能够读到这些配置，因为这个<code class="language-plaintext highlighter-rouge">DemoSpringmvcApplication</code>拥有<code class="language-plaintext highlighter-rouge">@SpringBootApplication</code>注解。</p>

      <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">SpringApplicationBuilder</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">SpringApplicationBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">sources</span><span class="o">(</span><span class="nc">DemoSpringmvcApplication</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>      </div>

      <p>查看源码可知，<code class="language-plaintext highlighter-rouge">@SpringBootApplication</code>注解就是一个功能更加强大的<code class="language-plaintext highlighter-rouge">@Configuration</code></p>

      <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="nd">@Inherited</span>
<span class="nd">@SpringBootConfiguration</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="nd">@ComponentScan</span><span class="o">(</span><span class="n">excludeFilters</span> <span class="o">=</span> <span class="o">{</span> <span class="nd">@Filter</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FilterType</span><span class="o">.</span><span class="na">CUSTOM</span><span class="o">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="nc">TypeExcludeFilter</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
      <span class="nd">@Filter</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FilterType</span><span class="o">.</span><span class="na">CUSTOM</span><span class="o">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="nc">AutoConfigurationExcludeFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">SpringBootApplication</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>      </div>
    </blockquote>
  </li>
  <li>添加<code class="language-plaintext highlighter-rouge">WebEnvironmentPropertySourceInitializer</code>监听，监听的事件是 <code class="language-plaintext highlighter-rouge">ApplicationEnvironmentPreparedEvent</code>（当SpringApplication正在启动并且环境首次可供检查和修改时发布的事件）</li>
  <li>构建SpringApplication，如果<code class="language-plaintext highlighter-rouge">configure</code>没有配置源，会检查自己是否是配置类，如果是就加到<code class="language-plaintext highlighter-rouge">primarySources</code>中，意味着其实如果<code class="language-plaintext highlighter-rouge">SpringBootServletInitializer</code>的子类就是配置类，默认会添加到source中</li>
  <li>确保注册了错误页面</li>
  <li>运行</li>
</ol>

<h2 id="servletcontextinitializer">ServletContextInitializer</h2>

<h3 id="什么是servletcontextinitializer">什么是ServletContextInitializer</h3>

<p>它的方法和<code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code>一模一样，但是它是<code class="language-plaintext highlighter-rouge">SpringBoot</code>提供的</p>

<p>我们看看源码怎么描述的</p>

<blockquote>
  <p>用于以编程方式配置Servlet 3.0+{@link ServletContext Context}的接口。与 WebApplicationInitializer 不同的是实现此接口(且不实现 WebApplicationInitializer)的类<b>不会</b>被 SpringServletContainerInitializer 检测到，因此Servlet容器不会自动引导</p>

  <p>此接口的设计方式类似于ServletContainerInitializer，但其生命周期由Spring管理，而不是Servlet容器。</p>

  <p>有关配置示例，请参阅 WebApplicationInitializer</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Interface used to configure a Servlet 3.0+ {@link ServletContext context}
 * programmatically. Unlike {@link WebApplicationInitializer}, classes that implement this
 * interface (and do not implement {@link WebApplicationInitializer}) will &lt;b&gt;not&lt;/b&gt; be
 * detected by {@link SpringServletContainerInitializer} and hence will not be
 * automatically bootstrapped by the Servlet container.
 * &lt;p&gt;
 * This interface is designed to act in a similar way to
 * {@link ServletContainerInitializer}, but have a lifecycle that's managed by Spring and
 * not the Servlet container.
 * &lt;p&gt;
 * For configuration examples see {@link WebApplicationInitializer}.
 *
 * @author Phillip Webb
 * @since 1.4.0
 * @see WebApplicationInitializer
 */</span>
<span class="nd">@FunctionalInterface</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServletContextInitializer</span> <span class="o">{</span>

   <span class="cm">/**
    * Configure the given {@link ServletContext} with any servlets, filters, listeners
    * context-params and attributes necessary for initialization.
    * @param servletContext the {@code ServletContext} to initialize
    * @throws ServletException if any call against the given {@code ServletContext}
    * throws a {@code ServletException}
    */</span>
   <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="为什么另外设计了这个接口">为什么另外设计了这个接口？</h3>

<p>不是可以直接实现一个<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>吗？为什么要另外用这个接口去实现相同的功能。</p>

<p>因为设计者，就是不让内嵌容器支持<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>，可以在这个<a href="https://github.com/spring-projects/spring-boot/issues/321">issue</a>中找到些答案</p>

<p>This was actually an intentional design decision. The search algorithm used by the containers was problematic. It also causes problems when you want to develop an executable WAR as you often want a <code class="language-plaintext highlighter-rouge">javax.servlet.ServletContainerInitializer</code> for the WAR that is not executed when you run <code class="language-plaintext highlighter-rouge">java -jar</code>.</p>

<p>See the <code class="language-plaintext highlighter-rouge">org.springframework.boot.context.embedded.ServletContextInitializer</code> for an option that works with Spring Beans.</p>

<p>Do you have a specific case where this is causing problems or was it more of an observation?</p>

<blockquote>
  <p>这实际上是一个有意的设计决定。容器使用的搜索算法存在问题。当您想要开发一个可执行的WAR时，这也会导致问题，因为您通常需要一个javax.servlet.ServletContainerInitializer用于在运行java-jar时不执行的WAR。</p>

  <p>有关使用SpringBean的选项，请参阅org.springframework.boot.context.embedded.ServletContextInitializer。</p>
</blockquote>

<p>我的理解是，当你的项目在开发时，为了开发方便，你可能使用的是内嵌的容器。而当部署到生成环境可能用的是war包的方式，部署到外部的容器中。这样你的代码必须同时兼容这两种方式。例如这样</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoSpringmvcApplication</span> <span class="kd">extends</span> <span class="nc">SpringBootServletInitializer</span> <span class="o">{</span>

    <span class="c1">// 使用内嵌容器时，main方法入口在这里，启动初始化的某个时间段我也启动了我的内嵌容器</span>
	  <span class="c1">// 使用外部容器时，忽略我的存在</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">DemoSpringmvcApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 使用内嵌容器时，我不会被调用。</span>
    <span class="c1">// 外部容器时，外部容器检测到 SpringServletContainerInitializer，然后又检测到继承自WebApplicationInitializer的我，然后我被调用了，初始化也开始了</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">SpringApplicationBuilder</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">SpringApplicationBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">sources</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>如果内嵌容器支持<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>，那这份代码运行就会有意向不到的问题，当然会有什么问题，我也不清楚😂</p>

<h3 id="servletcontextinitializer怎么被调用的">ServletContextInitializer怎么被调用的</h3>

<p>链路很长，我就找<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>被调用的关键代码</p>

<p>首先，在<code class="language-plaintext highlighter-rouge">ServletWebServerApplicationContext#onRefresh</code>里会调用createWebServer，顾名思义，创建web容器</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRefresh</span><span class="o">()</span> <span class="o">{</span>
   <span class="kd">super</span><span class="o">.</span><span class="na">onRefresh</span><span class="o">();</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="n">createWebServer</span><span class="o">();</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Unable to start web server"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>可以看到，在<code class="language-plaintext highlighter-rouge">createWebServer</code>根据 <code class="language-plaintext highlighter-rouge">webServer == null &amp;&amp; servletContext == null</code>说明我在创建应用上下文之前并没有外部容器启动，那么就创建一个内嵌容器，<code class="language-plaintext highlighter-rouge">factory.getWebServer(getSelfInitializer())</code>，传入了servletContextInitializers，</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">createWebServer</span><span class="o">()</span> <span class="o">{</span>
   <span class="nc">WebServer</span> <span class="n">webServer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">webServer</span><span class="o">;</span>
   <span class="nc">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">webServer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">servletContext</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ServletWebServerFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">getWebServerFactory</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">webServer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getWebServer</span><span class="o">(</span><span class="n">getSelfInitializer</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">servletContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="n">getSelfInitializer</span><span class="o">().</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="nc">ServletException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Cannot initialize servlet context"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="n">initPropertySources</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>方法调用 <code class="language-plaintext highlighter-rouge">createWebServer</code> -&gt; <code class="language-plaintext highlighter-rouge">getWebServer</code> -&gt; <code class="language-plaintext highlighter-rouge">prepareContext</code> -&gt; <code class="language-plaintext highlighter-rouge">configureContext</code></p>

<p>然后就来到了<code class="language-plaintext highlighter-rouge">configureContext</code>，有一步很关键，<code class="language-plaintext highlighter-rouge">context.addServletContainerInitializer(starter, NO_CLASSES)</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureContext</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">TomcatStarter</span> <span class="n">starter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TomcatStarter</span><span class="o">(</span><span class="n">initializers</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="k">instanceof</span> <span class="nc">TomcatEmbeddedContext</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">TomcatEmbeddedContext</span> <span class="n">embeddedContext</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TomcatEmbeddedContext</span><span class="o">)</span> <span class="n">context</span><span class="o">;</span>
      <span class="n">embeddedContext</span><span class="o">.</span><span class="na">setStarter</span><span class="o">(</span><span class="n">starter</span><span class="o">);</span>
      <span class="n">embeddedContext</span><span class="o">.</span><span class="na">setFailCtxIfServletStartFails</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="n">context</span><span class="o">.</span><span class="na">addServletContainerInitializer</span><span class="o">(</span><span class="n">starter</span><span class="o">,</span> <span class="no">NO_CLASSES</span><span class="o">);</span>
   <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>我们看一下这个方法，它往里面放的不是别人，正是大名鼎鼎的<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Add a ServletContainerInitializer instance to this web application.
 *
 * @param sci       The instance to add
 * @param classes   The classes in which the initializer expressed an
 *                  interest
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addServletContainerInitializer</span><span class="o">(</span>
        <span class="nc">ServletContainerInitializer</span> <span class="n">sci</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span><span class="o">);</span>
</code></pre></div></div>

<p>那我们看看这个<code class="language-plaintext highlighter-rouge">TomcatStarter</code>是何方神圣，仔细一看，里面就是依次调用传入的 ServletContextInitializers</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TomcatStarter</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Log</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LogFactory</span><span class="o">.</span><span class="na">getLog</span><span class="o">(</span><span class="nc">TomcatStarter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">;</span>

   <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Exception</span> <span class="n">startUpException</span><span class="o">;</span>

   <span class="nc">TomcatStarter</span><span class="o">(</span><span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">initializers</span> <span class="o">=</span> <span class="n">initializers</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="k">for</span> <span class="o">(</span><span class="nc">ServletContextInitializer</span> <span class="n">initializer</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">initializers</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">initializer</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">startUpException</span> <span class="o">=</span> <span class="n">ex</span><span class="o">;</span>
         <span class="c1">// Prevent Tomcat from logging and re-throwing when we know we can</span>
         <span class="c1">// deal with it in the main thread, but log for information here.</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isErrorEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error starting Tomcat context. Exception: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">". Message: "</span>
                  <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="nc">Exception</span> <span class="nf">getStartUpException</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">startUpException</span><span class="o">;</span>
   <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>看到这里，我们发现了内嵌的tomcat不会以spi方式加载<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>，而是用<code class="language-plaintext highlighter-rouge">TomcatStarter</code>的onStartup，间接启动<code class="language-plaintext highlighter-rouge">ServletContextInitializers</code>，来达到<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>的效果。</p>

<p>是不是有点像 <code class="language-plaintext highlighter-rouge">SpringServletContainerInitializer</code>老大哥带<code class="language-plaintext highlighter-rouge">WebApplicationInitializer</code>的套路</p>

<p>所以<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>源码里让你参考<code class="language-plaintext highlighter-rouge">@see WebApplicationInitializer</code>也不是没道理</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">*</span>
 <span class="o">*</span> <span class="nd">@author</span> <span class="nc">Phillip</span> <span class="nc">Webb</span>
 <span class="o">*</span> <span class="nd">@since</span> <span class="mf">1.4</span><span class="o">.</span><span class="mi">0</span>
 <span class="o">*</span> <span class="nd">@see</span> <span class="nc">WebApplicationInitializer</span>
 <span class="o">*/</span>
<span class="nd">@FunctionalInterface</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServletContextInitializer</span> <span class="o">{</span>
</code></pre></div></div>

<h3 id="servletcontextinitializer应用">ServletContextInitializer应用</h3>

<p>那ServletContextInitializer有现成的应用吗？</p>

<p>有！<code class="language-plaintext highlighter-rouge">DispatcherServletRegistrationBean</code>，它是什么？在检测到<code class="language-plaintext highlighter-rouge">DispatcherServletAutoConfiguration</code>配置看，生效后<code class="language-plaintext highlighter-rouge">DispatcherServletRegistrationBean</code>就交由spring的IOC容器管理了，因此<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>能够被拿到</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@AutoConfigureOrder</span><span class="o">(</span><span class="nc">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">)</span>
<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@ConditionalOnWebApplication</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">Type</span><span class="o">.</span><span class="na">SERVLET</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="nc">DispatcherServlet</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@AutoConfigureAfter</span><span class="o">(</span><span class="nc">ServletWebServerFactoryAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DispatcherServletAutoConfiguration</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
	<span class="nd">@Conditional</span><span class="o">(</span><span class="nc">DispatcherServletRegistrationCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="nc">ServletRegistration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">WebMvcProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">DispatcherServletConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DispatcherServletRegistrationConfiguration</span> <span class="o">{</span>
		<span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="no">DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME</span><span class="o">)</span>
		<span class="nd">@ConditionalOnBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">DispatcherServlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="no">DEFAULT_DISPATCHER_SERVLET_BEAN_NAME</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">DispatcherServletRegistrationBean</span> <span class="nf">dispatcherServletRegistration</span><span class="o">(</span><span class="nc">DispatcherServlet</span> <span class="n">dispatcherServlet</span><span class="o">,</span>
				<span class="nc">WebMvcProperties</span> <span class="n">webMvcProperties</span><span class="o">,</span> <span class="nc">ObjectProvider</span><span class="o">&lt;</span><span class="nc">MultipartConfigElement</span><span class="o">&gt;</span> <span class="n">multipartConfig</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">DispatcherServletRegistrationBean</span> <span class="n">registration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DispatcherServletRegistrationBean</span><span class="o">(</span><span class="n">dispatcherServlet</span><span class="o">,</span>
					<span class="n">webMvcProperties</span><span class="o">.</span><span class="na">getServlet</span><span class="o">().</span><span class="na">getPath</span><span class="o">());</span>
			<span class="n">registration</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="no">DEFAULT_DISPATCHER_SERVLET_BEAN_NAME</span><span class="o">);</span>
			<span class="n">registration</span><span class="o">.</span><span class="na">setLoadOnStartup</span><span class="o">(</span><span class="n">webMvcProperties</span><span class="o">.</span><span class="na">getServlet</span><span class="o">().</span><span class="na">getLoadOnStartup</span><span class="o">());</span>
			<span class="n">multipartConfig</span><span class="o">.</span><span class="na">ifAvailable</span><span class="o">(</span><span class="nl">registration:</span><span class="o">:</span><span class="n">setMultipartConfig</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">registration</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>它是这么拿的</p>

<ol>
  <li>
    <p>在前面讲的<code class="language-plaintext highlighter-rouge">org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext#createWebServer</code> 中调用 factory.getWebServer(getSelfInitializer())</p>
  </li>
  <li>
    <p>然后调用org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext#getServletContextInitializerBeans</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="nf">getServletContextInitializerBeans</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">return</span> <span class="k">new</span> <span class="nf">ServletContextInitializerBeans</span><span class="o">(</span><span class="n">getBeanFactory</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ServletContextInitializerBeans</code>这个类是一个封装了<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>的集合类，通过它的构造方法我们也能发现，它传入了<code class="language-plaintext highlighter-rouge">beanFactory</code>，不用看源码也能大概猜到它是从Spring容器中去找这些类的bean实例</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">ServletContextInitializerBeans</span><span class="o">(</span><span class="nc">ListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">,</span>
      <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">ServletContextInitializer</span><span class="o">&gt;...</span> <span class="n">initializerTypes</span><span class="o">){}</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="总结">总结</h2>

<p>说了那么多，这些类的出发点都是往<code class="language-plaintext highlighter-rouge">ServletContext</code>容器中注册<code class="language-plaintext highlighter-rouge">Servlet</code>,<code class="language-plaintext highlighter-rouge">Filter</code>或者<code class="language-plaintext highlighter-rouge">EventListener</code></p>

<p>只是生命周期由不同的容器托管，在不同的地方调用，但是最终的结果都是一样的</p>


  </div>
  <div class='post-footer'><a class='post-previous' href="/tech/2020/05/22/SpringBoot%E9%A1%B9%E7%9B%AE%E4%B8%ADweb.xml%E5%8E%BB%E5%93%AA%E4%BA%86.html">
      <i class="fa fa-chevron-left" aria-hidden="true"></i>
      Springboot项目中web.xml去哪了
    </a></div>
</article><div id='utterances' class="utterances-comments-header">
  <div>
    <div><strong></strong><a target="_blank" href="https://utteranc.es/">&nbsp;Utterances&nbsp;</a></strong>驱动</div>    
  </div><div><a target="_blank" href="https://github.com/uhfun/Uhfun-Jekyll/issues?q=傻傻分不清，ServletContainerInitializer、SpringServletContainerInitializer、WebApplicationInitializer、SpringBootServletInitializer、ServletContextInitializer都是些啥 | UhfunBlog"><strong>issue</strong></a></div>  
</div><script src="https://utteranc.es/client.js"
        repo= "uhfun/Uhfun-Jekyll"
        issue-term="og:title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  </div>
</article>

    </div>
  </div><footer class="footer">
  <div class="container">
    <div class="content has-text-centered">          
      <p><a href="https://uhfun.cn/tech/2020/05/22/%E5%82%BB%E5%82%BB%E5%88%86%E4%B8%8D%E6%B8%85-ServletContainerInitializer-SpringServletContainerInitializer-WebApplicationInitializer-SpringBootServletInitializer-ServletContextInitializer%E9%83%BD%E6%98%AF%E4%BA%9B%E5%95%A5.html">Github Pages</a>&nbsp;|&nbsp;<a href="https://uhfun.gitee.io/uhfun-jekyll/tech/2020/05/22/%E5%82%BB%E5%82%BB%E5%88%86%E4%B8%8D%E6%B8%85-ServletContainerInitializer-SpringServletContainerInitializer-WebApplicationInitializer-SpringBootServletInitializer-ServletContextInitializer%E9%83%BD%E6%98%AF%E4%BA%9B%E5%95%A5.html">Gitee Pages</a>&nbsp;|&nbsp;<a href="https://www.uhfun.cn/tech/2020/05/22/%E5%82%BB%E5%82%BB%E5%88%86%E4%B8%8D%E6%B8%85-ServletContainerInitializer-SpringServletContainerInitializer-WebApplicationInitializer-SpringBootServletInitializer-ServletContextInitializer%E9%83%BD%E6%98%AF%E4%BA%9B%E5%95%A5.html">Vps Pages</a><br>
        Copyright © Uhfun Blog 2019<br>
        Powered by <strong> <a target="_blank" href="https://github.com/jekyll/jekyll">Jekyll</a></strong>
        &nbsp;|&nbsp;Themed by <strong> <a target="_blank" href="https://github.com/uhfun/Uhfun-Jekyll">Uhfun-Jekyll</a></strong> 
        &nbsp; <br> licensed <a target="_blank" href="https://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a></a>.
        &nbsp;
      </p>
    </div>
  </div>
</footer>
<div class="back-to-top is-info">
    <a class="icon-stack">
        <ion-icon name="arrow-dropup">
            <svg class="svg-icon">
                <use xlink:href="/assets/arrow-dropup.svg"></use>
            </svg>
        </ion-icon>
        <span class="back-to-top-text">Top</span>
    </a>
</div>
<script src="/assets/js/back-to-top.js"></script>
<script src="/assets/js/drop-down.js"></script>
<script src="/assets/js/category-post-num.js"></script>
<script src="/assets/js/baidu-push.js"></script>
<script src="/assets/js/360-push.js"></script>
<script src="/assets/js/toc.js"></script></body>
<script src="/assets/js/date-format.js"></script>
</html>